---
title: "ODME Validation"
author: "Amar Sarvepalli"
date: "April 27, 2017"
output: 
  html_document:
    toc: yes
    toc_float: true
    keep_md: yes
    theme: cerulean
    highlight: tango
---

```{r setup4, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyr)
library(knitr)
library(ModelMetrics)
library(foreign)
library(ggplot2)
library(plotly)
library(DT)
library(broom)
library(rgdal)
library(leaflet)
```

# Chapter-4: ODME Validation

## 1. Data
The following are the list of data files used for the analysis in this document. 

```{r network links}

# path <-"/Volumes/C/projects/SERPM_Compare/highway_stats/Flagler"
path <- paste(getwd(),"highway_stats",sep="/")

hwy_links_file <- "subarea_shapeFile/Flagler_ODME_Loaded.dbf"
hwy_subarea_before_odme <- "data/before_ODME.dbf"
hwy_regional_before_odme <- "data/regional_before_ODME.dbf"
hwyshapeFile <- "subarea_shapeFile/Flagler_ODME_Loaded.shp"

Flagler_links_file <- "data/PB_Flagler_Count_Location.csv"
Flagler_counts_file <- "data/PB_Flagler_Counts.csv"
Flagler_all_links_file <- "data/Flagler_Subnet_Links.csv"
```

**DAILY_TEM4_300Iter.dbf** : is the final ODME subarea loaded network. The initial settings of 12 loops showed the ODME process did not converge, where the %RMSE between the Count and Volume was checked. The convergence criteria was set at 15% for subarea wide RMSE.  This condition was not met within default 12 iterations and thus additional iterations up to 300 feedback loops were run. The %RMSE at the end of 12 iteration was only 27% which clearly shows the ODME needs to be re-run. At the end of 300th iteration, the %RMSE is still at 17% and typically for a subarea wide it should be under 14%. Meaning more iterations can be run, however, before making that call, we need to understand the ODME results and why it didn't converge.

**before_ODME.dbf** : is the processed subarea network links with volumes prior to ODME. The networks are time period specific and carry regional nodes numbering. The subarea network file with old and new nodes is used to convert the regional networks to one single dbf file with just volume and counts by time periods.

**regional_before_ODME.dbf** : is the final loaded regional assignment network. The links and nodes are subset to represent subarea region. Technically **before_ODME.dbf** and **regional_before_ODME.dbf** should be identical, however, they are not although very close. Most of the tables show both before ODME volumes. 

**DAILY_TEM4_Link.shp** : final ODME results, same as **DAILY_TEM4_300Iter.dbf** but a shape file.

**PB_Flagler_Count_Location.csv** : List of subarea links where PB collected traffic counts.

**PB_Flagler_Counts.csv** : PB counts 

**Flagler_Subnet_Links.csv** : All Flagler Corridor links where there are counts (not PB collected counts).

```{r read files, echo=FALSE}
# Read data files
hwylinks <- read.dbf(paste0(path,"/",hwy_links_file))
hwylinks.before <- read.dbf(paste0(path,"/",hwy_subarea_before_odme))
hwylinks.regional <- read.dbf(paste0(path,"/",hwy_regional_before_odme))

flagler.links <- read.csv(paste0(path,"/",Flagler_links_file))
flagler.counts <- read.csv(paste0(path,"/",Flagler_counts_file))
flagler.all.links <-  read.csv(paste0(path,"/",Flagler_all_links_file))
```


## 2. Introduction
### 2.1 Origin Destination Matrix Estimation (ODME)

The latest delivered model from Feb 08, 2017 was run with 2010 seed skim with ODME turned on. The ODME procedure was applied by time period. For each of the time periods, root mean square error was generated by volume group, facility type and area type. However, the final validation statistics were computed on the daily results, which are not a true depiction of the ODME results. Thus additional statistics such as Root Mean Square Error (RMSE and %RMSE), Correlation Coefficient R^2^ were computed by time periods.

Additionally, stats from the before ODME procedure were looked to assess the ODME improvement. There are two way to get loaded network before ODME process. 

#### Method 1: Regional Assignment
The before ODME volumes were extracted from the final loaded network of the regional highway assignment **{OUTDIR}\DAILY_LOADED.net** . However, the counts in this network seemed not updated and are different from the subarea network counts. For this reason, the ODME before and after comparisons with this network may not give correct assessment of the ODME improvements.  

#### Method 2: Extract Subarea OD Tables
Before initiating the ODME procedure, the subarea OD trip tables were generated for each time period by assigning the regional OD trip tables to the regional network with subarea network option turned on.  This resulted in a subarea OD matrix as well as a loaded regional network for each time period. The following loaded regional networks were exported to **dbf links** and post processed to retain volumes. 

1. EA - {OUTDIR}\subarea\01HWY00D.NET
2. AM - {OUTDIR}\subarea\01HWY00A.NET
3. MD - {OUTDIR}\subarea\01HWY00E.NET
4. AM - {OUTDIR}\subarea\01HWY00F.NET
5. AM - {OUTDIR}\subarea\01HWY00G.NET

In order to compare the link volume from the regional model (before ODME) to subarea model (after ODME), the links nodes should be mapped. This mapping is done by exporting **subarea.net** to both **link.dbf** and **node.dbf** files, where **node.dbf** contains node correspondence between regional and subarea networks, and **link.dbf** contains the links that can be be compared to subarea ODME results. 

### 2.2 ODME in CUBE

ODME process in cube has many options to choose the targets from links counts, screen-lines, trip ends (zonal origins and destinations), paths, previously developed OD matrix and combination of these. The general method is the loaded network is converted into a specific format called ICM file, for efficient use where volumes, counts and other path choice settings are specified. Along with this file, screen-lines (link count locations) can be supplied and OD trip ends can be supplied. Each of these targets contains confidence thresholds that sets priority to targets. For this application the following targets and confidences were used:

1. Link Counts (Screen-line) with confidence of 1000 to 5000 (highest)
2. OD trip ends (subarea OD developed from regional model) with confidence of 100 (second level)
3. OD trip interchanges (cells) with confidence of 1 (lowest priority)

High level overview of the process:

1. Extract Subarea network (user defined boundary). Typically this process extracts OD table but here, it is used (or not done this way and Subarea OD is extracted separately)
2. Add additional counts to the subarea network
3. Extract Subarea OD tables via highway assignment. Inputs are regional networks, subarea network from step 2 and regional OD tables. The resulting outputs are Subarea OD tables and regional network with loaded volumes. The assignment rel-gap and max iterations are same as regional model. 
4. Convert loaded networks to ICM format and develop ODME targets: screen-line count locations, and subarea OD trip ends. This process is done through highway assignment. The assignment rel-gap and max iterations are slightly different, which should have been the same as above if this only for data conversion step.
5. ODME process: Cube manual shows variety of optimization procedures and standard reporting outputs. The reports produced here shows ODME stats by RMSE, %RMSE and R^2^. 
6. Iterative: Feedback to step 4. This entire process is repeated till the RMSE from Step 4 is under 15. The RMSE is computed between Volumes and Counts, which is similar to RMSE from 5.

So, the only standard report from ODME process is the report produced in step 5 where the process lists ODME results for each ODME iteration. The convergence criteria used here are 


```{r RMSE and Plot Function, echo=FALSE, message=FALSE, warning=FALSE}

ValidateHwyVolume <- function(df) {
  
# TODO:: try lazy eval here

# Target RMSE
targetRMSE <- cbind(Target = c("45% - 55%", "35% - 45%", "27% - 35%", 
                              "24% - 27%", "22% - 24%", "20% - 22%", 
                              "18% - 20%", "17% - 18%", "16% - 17%", 
                              "15% - 16%", "14% - 15%", " LT 14%", 
                              "32% - 39%"),
                    volBin = c(" 1 - 5,000", " 5,000 - 10,000", " 10,000 - 20,000",
                               " 20,000 - 30,000", " 30,000 - 40,000", " 40,000 - 50,000",
                               " 50,000 - 60,000"," 60,000 - 70,000"," 70,000 - 80,000",
                               " 80,000 - 90,000"," 90,000 - 100,000"," above 100,000 ",
                               "All")
              ) %>% tbl_df()
    
# Compute volume groups
test <- df %>% 
        mutate(volBin = case_when(.$Counts %in% c(1:5000) ~ " 1 - 5,000",
                                  .$Counts %in% c(5001:10000)  ~ " 5,000 - 10,000",
                                  .$Counts %in% c(10001:20000) ~ " 10,000 - 20,000",
                                  .$Counts %in% c(20001:30000) ~ " 20,000 - 30,000",
                                  .$Counts %in% c(30001:40000) ~ " 30,000 - 40,000",
                                  .$Counts %in% c(40001:50000) ~ " 40,000 - 50,000",
                                  .$Counts %in% c(50001:60000) ~ " 50,000 - 60,000",
                                  .$Counts %in% c(60001:70000) ~ " 60,000 - 70,000",
                                  .$Counts %in% c(70001:80000) ~ " 70,000 - 80,000",
                                  .$Counts %in% c(80001:90000) ~ " 80,000 - 90,000",
                                  .$Counts %in% c(90001:100000) ~ " 90,000 - 100,000",
                                  .$Counts > 100000 ~ " above 100,000 ")
              ) %>%
        filter(Counts > 0) 


  # Compute stats by vol group    
  ComputeStats <- function(df) {
    stats <- df %>% 
           summarise(
              RMSE = round(rmse(Counts, Volumes),2),
              Model.Est = round(sum(Volumes),0),
              Obs.Count = round(sum(Counts),0),
              Links = n(),
              PRMSE = round(RMSE * Links / Model.Est, 4),  # 100  scaling is auto under DT::formatpercentage()
              R.Squared = round(cor(Counts, Volumes)^2,4)
           )  
 
    return(stats)
  }

  # Get Daily stats
  stats.daily <-  test %>% 
                  ComputeStats() %>%
                  mutate(volBin =  "All")
  
  # Get volume groups stats
  stats.volGroups <-  test %>% 
                  group_by(volBin) %>%
                  ComputeStats() 
 
  # Get  Facility Type groups stats
  stats.FT <-  test %>% 
                  group_by(FTG) %>%
                  ComputeStats() 
  
  # Get Area Type groups stats
  stats.AT <-  test %>% 
                  group_by(ATG) %>%
                  ComputeStats() 
    
  stats <- rbind(stats.daily, stats.volGroups) %>%
           arrange(volBin) %>% 
           select(volBin, Links, Obs.Count, Model.Est, PRMSE, R.Squared)
  
  # Add RMSE Targets
  stats <- left_join(stats, targetRMSE, by = "volBin") %>%
           select(volBin, Links, Obs.Count, Model.Est, Target, PRMSE, R.Squared)
  
  m <- lm(Volumes ~ Counts, data = test)
  # Scattered plots by daily group (add lm line)
  plot.daily <- plot_ly(data = test, x = ~Counts, color = I("black")) %>%
                add_markers(y = ~Volumes, name = "Volume to Counts") %>%
                add_lines(y = ~fitted(lm(Volumes ~ Counts)),
                          line = list(color = 'rgba(7, 164, 181, 1)'),
                          name = "Best Fit Curve") %>%
                add_ribbons(data = augment(m),
                          ymin = ~.fitted - 1.96 * .se.fit,
                          ymax = ~.fitted + 1.96 * .se.fit,
                          line = list(color = 'rgba(7, 164, 181, 0.05)'),
                          fillcolor = 'rgba(7, 164, 181, 0.2)',
                          name = "Standard Error") 
   
  # Scatted plots by volume group
  plot.volgrp <- plot_ly(data = test, x = ~Counts, y = ~Volumes, color = ~volBin)
  
  # scatted plot by Facility Type
  plot.FT <- plot_ly(data = test, x = ~Counts, y = ~Volumes, color = ~as.character(FTG))
    
  # scatted plot by Facility Type
  plot.AT <- plot_ly(data = test, x = ~Counts, y = ~Volumes, color = ~as.character(ATG))
    
  hwyStatsPlots <- list(stats = stats, atStats = stats.AT, ftStats = stats.FT, volAllPlot = plot.daily, volBinPlot = plot.volgrp, 
                        ftPlot = plot.FT, atPlot = plot.AT)
  return(hwyStatsPlots)

}

```

## 3. AM Period

Some of the stats: observed counts, model volumes, RMSE, %RMSE, R-Squared and Scattered Plots were computed by:

* By Volume Group
* By Facility Type
* By Area Type

for the following time periods

* AM
* PM
* Daily

### 3.1 AM Highway Stats {.tabset .tabset-fade .tabset-pills}

#### 3.1.1 AM Stats by volume groups
1. **Regional - Before ODME** : The AM volumes before ODME process were extracted from the regional assignment. The total number of links with counts in the subarea are only 208. It is extremely hard to tell the year for this count although the field CNT_AM_10 might imply 2010 counts. The subarea wide %RMSE is 62% and the R^2^ is at 0.82. Most of the low volume and high volume groups shows R^2^ under 0.5

```{r AM Stats region before , message=FALSE, warning=FALSE, echo=FALSE}
  # AM stats before ODME
  AM.regional <-  hwylinks.regional %>% 
  select(CNT10_AM, AM_V_1, FTG, ATG) %>%
  rename(Counts = CNT10_AM, Volumes = AM_V_1) %>% ValidateHwyVolume()

  DT::datatable(AM.regional$stats, caption = "Regional - Before ODME") %>% formatPercentage("PRMSE", 2)

```

2. **Subarea - Before ODME** : Theoretically this should be same as above. Since the ODME subarea OD matrix extraction process uses a re-assignment of the regional trips tables, a new loaded highway networks are generated. The assignment settings here match to regional assignment. The model volume by volume group (volBin) shows significant difference from the above table. The count in this table are updated with ODME counts for the subarea. The subarea wide R^2^ is slightly better at 0.84, however it is hard to tell if this is due to change in counts or more number of counts (256 counts instead of regional 208 counts as above). 

```{r AM Stats ODME before, message=FALSE, warning=FALSE, echo=FALSE}
  # AM stats before ODME
  AM.before <-  hwylinks.before %>% 
  select(CNT10_AM, AM_V_1, FTG, ATG) %>%
  rename(Counts = CNT10_AM, Volumes = AM_V_1) %>% ValidateHwyVolume()

  DT::datatable(AM.before$stats, caption = "Subarea - Before ODME") %>% formatPercentage("PRMSE", 2)
```

3. **Subarea - After ODME** : Shows ODME results, where R^2^ for subarea is at 0.96 and %RMSE is at 17%. The ODME feedback loop at 300th iteration shows %RMSE of 17.7% and ideally this should be under 14% meaning more number of iterations or more counts are required.


```{r AM Stats ODME after, message=FALSE, warning=FALSE, echo=FALSE}
  # AM stats
  AM <-  hwylinks %>% 
  select(CNT10_AM, AM_V_1, FTG, ATG) %>%
  rename(Counts = CNT10_AM, Volumes = AM_V_1) %>% ValidateHwyVolume()

  DT::datatable(AM$stats, caption = "Subarea - After ODME") %>%
      formatPercentage("PRMSE", 2)
  
```

#### 3.1.2 AM Stats by Facility Type
```{r}
 DT::datatable(AM.before$ftStats, caption = "Subarea - Before ODME") %>% formatPercentage("PRMSE", 2)
 DT::datatable(AM$ftStats, caption = "Subarea - After ODME") %>% formatPercentage("PRMSE", 2)
```

#### 3.1.3 AM Stats Area Type
```{r}
 DT::datatable(AM.before$atStat, caption = "Subarea - Before ODME") %>% formatPercentage("PRMSE", 2)
 DT::datatable(AM$atStat, caption = "Subarea - After ODME") %>% formatPercentage("PRMSE", 2)
```

### 3.2 AM Scattered Plots {.tabset .tabset-fade .tabset-pills}

The plots below show a comparison between ODME counts and ODME results by volume group, facility type and area types.  

#### 3.2.1 AM Scattered Plots (by volume groups)
Most of the data points by volume groups align well, however, there are few outlier in 1 - 5,000 group and 10,000 - 20,000 group. 

```{r AM Stats all, message=FALSE, warning=FALSE}
  # AM plots
  AM$volBinPlot

```


#### 3.2.2 AM Scattered Plots (all volume groups)
Most of the data points fall close to the "best fit line", however there are few that fall way off the line. 

```{r AM Stats vol groups, message=FALSE, warning=FALSE}
  # AM plots
  AM$volAllPlot

```

#### 3.2.3 AM Scattered Plots (Facility Type group)

Most of the ODME results looks fine by Facility Type, however, types 1 and 7 show some link volumes way over or under. These links need to be studied further to determine if there is a count issue.

```{r AM Stats FT groups, message=FALSE, warning=FALSE}
  # AM plots
  AM$ftPlot

```

#### 3.2.4 AM Scattered Plots (area Type groups)

Most of the ODME results looks fine by Area Type, however, types 3 and 4 show some link volumes that are way over or under. These links need to be studied further to determine if there is a count issue.

```{r AM Stats AT groups, message=FALSE, warning=FALSE}
  # AM plots
  AM$atPlot

```


### 3.3 Map AM Links by volume group
```{r map links, echo = FALSE}
# Read in data, and subset for the selected volume group
hwylinksShape  <- readOGR(hwyshapeFile, layer = "Flagler_ODME_Loaded", verbose = FALSE)

# Compute volume bins
hwylinksShape@data <- hwylinksShape@data %>%
        mutate(volBin = case_when(.$CNT10_AM %in% c(1:5000) ~ 1L,
                                  .$CNT10_AM %in% c(5001:10000)  ~ 2L,
                                  .$CNT10_AM %in% c(10001:20000) ~ 3L,
                                  .$CNT10_AM %in% c(20001:30000) ~ 4L,
                                  .$CNT10_AM %in% c(30001:40000) ~ 5L,
                                  .$CNT10_AM %in% c(40001:50000) ~ 6L,
                                  .$CNT10_AM %in% c(50001:60000) ~ 7L,
                                  .$CNT10_AM %in% c(60001:70000) ~ 8L,
                                  .$CNT10_AM %in% c(70001:80000) ~ 9L,
                                  .$CNT10_AM %in% c(80001:90000) ~ 10L,
                                  .$CNT10_AM %in% c(90001:100000) ~ 11L,
                                  .$CNT10_AM > 100000 ~ 12L)
              ) 

 pal <- colorBin(topo.colors(12), hwylinksShape$volBin, 12)

 hwy_vol_5K <- subset(hwylinksShape, hwylinksShape$CNT10_AM %in% c(1:5000))
 hwy_vol_10K <- subset(hwylinksShape, hwylinksShape$CNT10_AM %in% c(5001:10000))
 hwy_vol_20K <- subset(hwylinksShape, hwylinksShape$CNT10_AM %in% c(10001:20000))
 hwy_vol_30K <- subset(hwylinksShape, hwylinksShape$CNT10_AM %in% c(20001:30000))
 hwy_vol_30pK <- subset(hwylinksShape, hwylinksShape$CNT10_AM > 30000)
 
 map <- leaflet() %>%
      addProviderTiles("Stamen.Toner",group = "Stamen") %>%
      addProviderTiles('CartoDB.Positron') %>%
      addTiles(group = "OSM") %>%
      
      # Add all links
      addPolylines(data = hwylinksShape, stroke = TRUE, smoothFactor = 0, weight = 2, 
                  color = "grey", 
                  #color = ~pal(hwylinksShape$volBin),
                  group = "hwy links",
                  popup = paste("A-B = <b>", paste(hwylinksShape$A,hwylinksShape$B,sep = "-") , "</b><br/>", 
                                "Observed = ", hwylinksShape$CNT10_AM,  "<br/>",
                                "Estimated = ", round(hwylinksShape$AM_V_1,0), "</b><br/>",
                                "FTG = ", hwylinksShape$FTG,  "<br/>",
                                "ATG = ", hwylinksShape$ATG)) %>%
     # Add < 5K links 
     addPolylines(data = hwy_vol_5K, stroke = TRUE, smoothFactor = 0, weight = 2, 
                  color = "blue", 
                  #color = ~pal(hwylinksShape$volBin),
                  group = "vol < 5K links",
                  popup = ~paste("A-B = <b>", paste(A,B,sep = "-") , "</b><br/>", 
                                "Observed = ", CNT10_AM,  "<br/>",
                                "Estimated = ", round(AM_V_1,0))) %>%   
     # Add 5K - 10K links 
     addPolylines(data = hwy_vol_10K, stroke = TRUE, smoothFactor = 0, weight = 2, 
                  color = "green", 
                  #color = ~pal(hwylinksShape$volBin),
                  group = "vol 5K - 10K links",
                  popup = ~paste("A-B = <b>", paste(A,B,sep = "-") , "</b><br/>", 
                                "Observed = ", CNT10_AM,  "<br/>",
                                "Estimated = ", round(AM_V_1,0))) %>%   
   
     # Add 10K - 20K 5K links 
     addPolylines(data = hwy_vol_20K, stroke = TRUE, smoothFactor = 0, weight = 2, 
                  color = "red", 
                  #color = ~pal(hwylinksShape$volBin),
                  group = "vol 10K - 20K links",
                  popup = ~paste("A-B = <b>", paste(A,B,sep = "-") , "</b><br/>", 
                                "Observed = ", CNT10_AM,  "<br/>",
                                "Estimated = ", round(AM_V_1,0))) %>%   
     
     # Add 20K - 30K links 
     addPolylines(data = hwy_vol_30K, stroke = TRUE, smoothFactor = 0, weight = 2, 
                  color = "black", 
                  #color = ~pal(hwylinksShape$volBin),
                  group = "vol 20K - 30K links",
                  popup = ~paste("A-B = <b>", paste(A,B,sep = "-") , "</b><br/>", 
                                "Observed = ", CNT10_AM,  "<br/>",
                                "Estimated = ", round(AM_V_1,0))) %>%   
      
     # Add layer controls
     addLayersControl(
       baseGroups = c("OSM", "Stamen"),
       overlayGroups = c( "vol < 5K links", "vol 5K - 10K links", 
                          "vol 10K - 20K links", "vol 20K - 30K links", 
                           "hwy links"), 
       options = layersControlOptions(collapsed = FALSE)
      )
 
    map
```


## 4. PM Period
Some of the stats: observed counts, model volumes, RMSE, %RMSE, R-Squared and Scattered Plots were computed by:

* By Volume Group
* By Facility Type
* By Area Type

for the following time periods

* AM
* PM
* Daily

### 4.1 PM Highway Stats {.tabset .tabset-fade .tabset-pills}

#### 4.1.1 PM Stats by volume groups

```{r PM Stats, message=FALSE, warning=FALSE}

  # PM stats before ODME
  PM.regional <-  hwylinks.regional %>% 
  select(CNT10_PM, PM_V_1, FTG, ATG) %>%
  rename(Counts = CNT10_PM, Volumes = PM_V_1) %>% ValidateHwyVolume()

  DT::datatable(PM.regional$stats, caption = "Regional - Before ODME") %>% formatPercentage("PRMSE", 2)
  

  # PM stats before ODME
  PM.before <-  hwylinks.before %>% 
  select(CNT10_PM, PM_V_1, FTG, ATG) %>%
  rename(Counts = CNT10_PM, Volumes = PM_V_1) %>% ValidateHwyVolume()

  DT::datatable(PM.before$stats, caption = "Subarea - Before ODME") %>% formatPercentage("PRMSE", 2)
  
  # PM stats
  PM <-  hwylinks %>% 
  select(CNT10_PM, PM_V_1, FTG, ATG) %>%
  rename(Counts = CNT10_PM, Volumes = PM_V_1) %>% ValidateHwyVolume()

  DT::datatable(PM$stats, caption = "Subarea - After ODME") %>% formatPercentage("PRMSE", 2)
  
```

#### 4.1.2 PM Stats by Facility Type
```{r}
 DT::datatable(PM.before$ftStats, caption = "Before ODME") %>% formatPercentage("PRMSE", 2)
 DT::datatable(PM$ftStats, caption = "After ODME") %>% formatPercentage("PRMSE", 2)
```

#### 4.1.3 PM Stats Area Type
```{r}
 DT::datatable(PM.before$atStats, caption = "Before ODME") %>% formatPercentage("PRMSE", 2)
 DT::datatable(PM$atStats, caption = "After ODME") %>% formatPercentage("PRMSE", 2)
```

### 4.2 PM Scattered Plots {.tabset .tabset-fade .tabset-pills}

#### 4.2.1 PM Scattered Plots (by volume groups)
```{r PM Stats all, message=FALSE, warning=FALSE}
  # PM plots
  PM$volBinPlot

```

#### 4.2.2 PM Scattered Plots (all volume groups)
```{r PM Stats vol groups, message=FALSE, warning=FALSE}
  # PM plots
  PM$volAllPlot

```

#### 4.2.3 PM Scattered Plots (Facility Type group)
```{r PM Stats FT groups, message=FALSE, warning=FALSE}
  # PM plots
  PM$ftPlot

```

#### 4.2.4 PM Scattered Plots (area Type groups)
```{r PM Stats AT groups, message=FALSE, warning=FALSE}
  # PM plots
  PM$atPlot

```




## 5. Daily

Some of the stats: observed counts, model volumes, RMSE, %RMSE, R-Squared and Scattered Plots were computed by:

* By Volume Group
* By Facility Type
* By Area Type

for the following time periods

* AM
* PM
* Daily

### 5.1 Daily Highway Stats {.tabset .tabset-fade .tabset-pills}
The daily highway stats were computed for before and after ODME links.

#### 5.1.1 Daily Stats by volume groups

```{r Daily Stats, message=FALSE, warning=FALSE, echo=FALSE}

  # Daily stats before ODME
  daily.before <-  hwylinks.before %>% 
  select(COUNT10, DAY_V_1, FTG, ATG) %>%
  rename(Counts = COUNT10, Volumes = DAY_V_1) %>% ValidateHwyVolume()

  DT::datatable(daily.before$stats, caption = "Subarea - Before ODME", options = list(sDom  = '<"top">lrt<"bottom">ip')) %>% formatPercentage("PRMSE", 2)
    

  # Daily stats after ODME
  daily <-  hwylinks %>% 
  select(COUNT10, DAY_V_1, FTG, ATG) %>%
  rename(Counts = COUNT10, Volumes = DAY_V_1) %>% ValidateHwyVolume()

  DT::datatable(daily$stats, caption = "Subarea - After OMDE") %>% formatPercentage("PRMSE", 2)
  
```

#### 5.1.2 Daily Stats by Facility Type
```{r}
 DT::datatable(daily.before$ftStats, caption = "Subarea - Before OMDE") %>% formatPercentage("PRMSE", 2)
 DT::datatable(daily$ftStats, caption = "Subarea - After OMDE") %>% formatPercentage("PRMSE", 2)
```

#### 5.1.3 Daily Stats Area Type
```{r}
 DT::datatable(daily.before$atStats) %>% formatPercentage("PRMSE", 2)
 DT::datatable(daily$atStats) %>% formatPercentage("PRMSE", 2)
```

### 5.2 Daily Scattered Plots {.tabset .tabset-fade .tabset-pills}

#### 5.2.1 Daily Scattered Plots (by volume groups)
```{r Daily Stats all, message=FALSE, warning=FALSE}
  # Daily plots
  daily$volBinPlot

```

#### 5.2.2 Daily Scattered Plots (all volume groups)
```{r Daily Stats vol groups, message=FALSE, warning=FALSE}
  # Daily plots
  daily$volAllPlot

```

#### 5.2.3 Daily Scattered Plots (Facility Type group)
```{r Daily Stats FT groups, message=FALSE, warning=FALSE}
  # Daily plots
  daily$ftPlot

```

#### 5.2.4 Daily Scattered Plots (Area Type groups)
```{r Daily Stats AT groups, message=FALSE, warning=FALSE}
  # Daily plots
  daily$atPlot

```

## 6. Flagler Link Counts

 There are a total of three sets of counts as described below:

1. Regional Counts in the Highway Network:  
2. Subarea Counts in the Highway Network (S7_2014_latest with counts-Flaglerfinal.NET): These are the revised counts (2014, I think ) added to subarea network.
3. PB Counts: 

### 6.1 PB Counts 
PB collected counts and processed them for use in ODME, however,these counts weren't used in the ODME process. 

Table below shows all three above counts and three volumes: Regional volume, Subarea Volume before ODME and after ODME.

1. Out of 40 locations where PB collected data, there were only 12 count locations where there is either a regional or ODME count coded in the network. 
2. Out of 12 locations where the counts exist, only 8 locations show a reasonable match between ODME Counts and ODME results. 
3. For the links that show only PB Counts, it appears that volumes from both the regional model and volumes before ODME come close to PB Counts. This puts entire ODME results questionable and not usable. 



```{r append flagler pb counts, echo = FALSE}
flagler.links <- flagler.links %>%
                 left_join(flagler.counts, by = c("pb_count_locations" = "Count.Location")) %>%
                 select(A, B, pb_count_locations, From, To, PB_AADT) %>%
                 mutate(key = paste0(A,"-",B),
                        link.AADT = PB_AADT / 2) %>%
                 select(-A, -B)

# Append counts and volumes - After ODME 
hwylinks <- hwylinks %>%
            mutate(key = paste0(A,"-", B))

flagler.links <- flagler.links %>% 
                 left_join(hwylinks, by = "key") %>%
                 select(key, pb_count_locations, From, To, PB_AADT, link.AADT,
                        ODME.Count = COUNT10, After.ODME = DAY_V_1)

# Append counts and volumes - Before ODME
hwylinks.before <- hwylinks.before %>%
            mutate(key = paste0(sub_A,"-", sub_B))

flagler.links <- flagler.links %>% 
                 left_join(hwylinks.before, by = "key") %>%
                 select(key, pb_count_locations, From, To, PB_AADT, link.AADT, 
                        ODME.Count, After.ODME, Before.ODME = DAY_V_1)
                        
# Append counts and volumes
hwylinks.regional <- hwylinks.regional %>%
            mutate(key = paste0(sub_A,"-", sub_B))

flagler.links <- flagler.links %>% 
                 left_join(hwylinks.regional, by = "key") %>%
                 select(key, pb_count_locations, From, To, PB_AADT, link.AADT, 
                        regional.count = COUNT10, regional.volume = DAY_V_1,
                        ODME.Count, After.ODME, Before.ODME) %>%
                 arrange(pb_count_locations)

DT::datatable(flagler.links, caption = "Flagler Links", filter = 'top')
  
```


### 6.2 Regional and ODME Counts 
In order to better understand the ODME results, not just at locations where PB collected the data but all along the Flagler Corridor, all Flagler links with available / network coded counts were studied. Table **Flagler Links with ODME Counts** below shows the links, ODME count and ODME results along with regional volumes, counts and PB counts where available. 


A total of 56 locations along Flagler Corridor contains counts used for ODME. Table **Summary of Flagler Links with ODME Counts** shows, out of 56 links with ODME counts along Flagler, about 33 are within 10% of the observed ODME count. 

Of these 56 locations, PB collected data was available at 12 locations. Click the empty cell / box under "PB_count_locations" then move slider to 1 to show select all rows where PB counts are available.  For the rows where the  % percent difference is high, the ODME results match close to PB counts. This clearly demonstrates that if we used PB counts in addition to ODME counts, the ODME results would have been lot better.

```{r append flagler all counts, echo = FALSE}
flagler.all.links <- flagler.all.links %>%
                 left_join(flagler.counts, by = c("pb_count_locations" = "Count.Location")) %>%
                 select(A, B, pb_count_locations, From, To, PB_AADT) %>%
                 mutate(key = paste0(A,"-",B),
                        link.AADT = PB_AADT / 2) %>%
                 select(-A, -B)

# Append counts and volumes - After ODME 
hwylinks <- hwylinks %>%
            mutate(key = paste0(A,"-", B))

flagler.all.links <- flagler.all.links %>% 
                 left_join(hwylinks, by = "key") %>%
                 select(key, pb_count_locations, From, To, PB_AADT, link.AADT,
                        ODME.Count = COUNT10, After.ODME = DAY_V_1)

# Append counts and volumes - Before ODME
hwylinks.before <- hwylinks.before %>%
            mutate(key = paste0(sub_A,"-", sub_B))

flagler.all.links <- flagler.all.links %>% 
                 left_join(hwylinks.before, by = "key") %>%
                 select(key, pb_count_locations, From, To, PB_AADT, link.AADT, 
                        ODME.Count, After.ODME, Before.ODME = DAY_V_1)
                        
# Append counts and volumes
hwylinks.regional <- hwylinks.regional %>%
            mutate(key = paste0(sub_A,"-", sub_B))

flagler.all.links <- flagler.all.links %>% 
                 left_join(hwylinks.regional, by = "key") %>%
                 select(key, pb_count_locations, From, To, PB_AADT, link.AADT, 
                        regional.count = COUNT10, regional.volume = DAY_V_1,
                        ODME.Count, After.ODME, Before.ODME)  %>%
                 mutate(ODME.pct.diff = ifelse(ODME.Count >0, 1 - (After.ODME / ODME.Count), 0 ))
                        
                 

# Get links where regional or ODME counts are available
flagler.all.links.regCounts <- flagler.all.links %>%
                               filter(ODME.Count > 0) 

DT::datatable(flagler.all.links.regCounts, filter = 'top', caption = "Flagler Links with ODME Counts") %>% formatPercentage("ODME.pct.diff", 0)

# Get links within 10% difference
flagler.all.links.regCounts <-  flagler.all.links.regCounts %>%
                                mutate(ODME.pct.diff.abs = abs(ODME.pct.diff))

flagler.all.links.regCounts <-  flagler.all.links.regCounts %>%
          mutate(pct.diff.bin = case_when(.$ODME.pct.diff.abs > 0 & .$ODME.pct.diff.abs <= 0.1 ~ "under 10 %",
                                          .$ODME.pct.diff.abs > 0.1 & .$ODME.pct.diff.abs <= 0.25 ~ "10 % - 25 %",
                                          .$ODME.pct.diff.abs > 0.25 & .$ODME.pct.diff.abs <= 0.5 ~ "25 % - 50 %",
                                          .$ODME.pct.diff.abs > 0.5 & .$ODME.pct.diff.abs <= 1.0 ~ "50 % - 100 %",
                                          .$ODME.pct.diff.abs > 1.0 ~ "over 100 %"))

summary.flagler <- flagler.all.links.regCounts %>%
            group_by(pct.diff.bin) %>%
            summarise( count = n()) 

DT::datatable(summary.flagler, caption = "Summary of Flagler Links with ODME Counts ") 


```


