---
title: "Southeast Florida Socio-Economic Data Trends"
author: "Amar Sarvepalli"
date: "January 30, 2017"
output: html_document
---

```{r setup2, include=FALSE, eval =FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Check and install, load required packages
required_packages <- c("dplyr", "tidyr", "knitr",  "foreign", "ggplot2", "leaflet", "plotly", "DT", "htmltools")
check_packages <- required_packages %in% rownames(installed.packages())
missing_packages <- required_packages[check_packages == FALSE]
install.packages(missing_packages)
for (i in 1:length(required_packages)) {library(required_packages[i], character.only = TRUE)}

# library(dplyr)
# library(tidyr)
# library(knitr)
# library(foreign)
# library(ggplot2)
# library(leaflet)
# library(rgdal)
# library(plotly)
```

#  Chapter-3: Southeast Florida Socio-Economic Data Trends
This chapter focuses on checking and reporting of socio-demographic and employment data from 2010, 2015 and 2040.


## 1. Data Processing
The regional planning models contains valuable data that can be used beyond travel demand forecasting needs. The forecasted landuse and employment are one of the most useful information for general use. However, in SERPM 7.0 this data exists in a few different places with similar names but with significant variations. 

SERPM is an activity based model and is one of the most sophisticated models where coordinated daily activity pattern is the epic center of its design, meaning it is designed to simulate varying travel patterns of each individuals of the households by taking their household socio-demographics and personal profiles into account. This model consists of various sequential sub-modules and use variants of the same data sets as required by each sub-models.  For this reason the disaggregate household and population variables such as: zero-car autos, zero-worker households, low-income households, population under age < 16 and over 65 plus can only be found in the output files. However, the zonal level household, population variables are user inputs and can be obtained from the inputs location. Although employment is also a user input file, this can only be found under inputs to ctramp folder, which is at a different location than landuse input files. 

As it can be seen, extracting useful general purpose information from the model is different and needs thorough understanding of the SERPM model. To address this issue, R-Script were developed to extract the model data.   

The SERPM model input and output files are pre-processed to produce model data file (*year_model_data.csv*) that are referred in this document. These files are generated by processing the following files:  

  1. input/ctramp/hhFile.csv : synthetic households output from PopSyn-3
  2. input/ctramp/maz_data.csv : employment data user input 
  3. output/ctramp/householdData_1.csv : coordinated daily activity pattern (cdap) household data from ctramp
  4. output/ctramp/personData_1.csv : coordinated daily activity pattern (cdap) person data from ctramp

*Note: Script **GetPopHH.R** is run on SERPM model results for 2010, 2015 and 2040 to extract **year_model_data.csv** files processes *

The first two are outputs from synthetic population generator. The household, population variables in the **ctramp/maz_data.csv** file doesn't necessarily agree with **PopSyn-3/maz_data.csv**, although they correspond to the household and population variables. This difference is due to balancing priorities used in PopSyn-3, where some of the variables are given a higher priority to match to control totals (usually at TAZ level). In cases where zonal data is being analyzed, it is better to use household and population data from input to PopSyn-3 instead of ctramp inputs.


## 2. Data Aggregation
As it is extremely difficult to analyze all the model data by TAZs and MAZs, the data is aggregated by larger geographies such as:

* Counties
* Cities
* Corridor Study Area
* Districts : User defined geography

For this report, data was aggregated by counties, districts and corridor study area. The data was not tabulated by cities although it can be done. The districts are defined as aggregated zones and some of the data was collected (AirSage OD trip flows) by these districts. For Flagler Corridor these districts are defined independently and so they are different from districts used in other corridor studies. Other corridors use MPO directed districts and all data collected and analysed is done through this district except for Flalger. The data presented here uses Flagler Corridor district system.

Flagler Corridor study area is comprised of four segments, however the segments 3 and 4 fall under the same districts and so only three segements were defined in this analysis.  The code chuck below shows the Flagler Districts by segments.  The following are the physical extents of the segments:

•	Segment 1 – NW/SW 107th Avenue from Flagler Street to NW 12th Street and NW 12th Street from NW 107th Avenue to NW 122nd Avenue.
•	Segment 2 – Flagler Street and SW 8th Street from SR 826/Palmetto Expressway to SW 147th Avenue via NW/SW 107th Avenue.
•	Segment 3 – Flagler Street from NW 27th Avenue to SR 826/Palmetto Expressway
•	Segment 4 – Flagler Street/1st Street from Downtown Transit Center to NW 27th Avenue



```{r User Inputs}
  
  # directory
  # projDir <-"/Volumes/C/projects/SERPM_Compare/extract_SERPM_SEData"
  projDir <- paste(getwd(),"extract_SERPM_SEData",sep="/")
  
  # data directory and files
  model_dir <- "model_data" 
  se_data_files <- c("2010_model_data.csv", "2015_model_data.csv", "2040_model_data.csv")
  poverty_data_files <- c("2010_poverty_by_TAZ.csv", "2015_poverty_by_TAZ.csv", "2040_poverty_by_TAZ.csv")
  
  # Taz to county lookup file (use shape file instead)
  taz_county_file <- "taz_county.csv"
  
  # District file to tabluate data for Flalger distritcs
  taz_district_file <- "SERPM_TAZ_AirSage_Dist.csv"
  segments_1 <- c(19:22,27,28,30)                # Flagler: 1st St to NW 27th Ave
  segments_2 <- c(25,31,33:35, 15)               # Flagler: NW 27th Ave to SR 826 Exp
  segments_3 <- c(36:40,601,602,591,592,56,48)   # SW 8th St: SR 826 Exp to SW 147th Ave
  Study_districts <- c(segments_1,segments_2,segments_3)
  
  # Write csv outputs
  write.csv.outputs <- FALSE
  
  # Save R Objects for later use
  save.RData.outputs <- TRUE
```


```{r Model Data, echo=FALSE}
  # read model files files
  data_2010 <- read.csv(paste0(projDir,"/",model_dir,"/",se_data_files[1])) %>% 
               mutate(year = 2010) %>% select(-X) 
  data_2015 <- read.csv(paste0(projDir,"/",model_dir,"/",se_data_files[2])) %>% 
               mutate(year = 2015) %>% select(-X) 
  data_2040 <- read.csv(paste0(projDir,"/",model_dir,"/",se_data_files[3])) %>% 
               mutate(year = 2040) %>% select(-X) 
  
  tazCounty <- read.csv(paste0(projDir,"/",model_dir,"/",taz_county_file))  %>%
               select(TAZ_REG, COUNTY)
  
  taz_dist_all <- read.csv(paste0(projDir,"/",model_dir,"/",taz_district_file)) %>%
               select(TAZ_REG, AirSageDistrict) %>%
               rename(Dist = AirSageDistrict, TAZ = TAZ_REG)
  
  # Compute households in poverty
  for (d in 1:length(poverty_data_files)) {
    poverty_data <-  read.csv(paste0(projDir,"/",model_dir,"/",poverty_data_files[d])) %>%
                 left_join(tazCounty, by = c("TAZ" = "TAZ_REG")) %>%
                 left_join(taz_dist_all, by = "TAZ") %>%
                 filter (COUNTY == 3) %>%
                 mutate (isCorridor = ifelse(Dist %in% Study_districts, 1, 0)) %>%
                 group_by(isCorridor) %>%
                 summarise(poverty_households = sum(households)) %>%
                 mutate(scenario = d)
     ifelse(d == 1, all_povert_data <- poverty_data, all_povert_data <- rbind(all_povert_data,poverty_data))

  }

  
  # Table for report (pop, emp by districts and years)
  data_all_years <- rbind(data_2010, data_2015, data_2040) %>%
                 select(TAZ, hh, pop, emp, year) %>% 
                 left_join(taz_dist_all, by = "TAZ") %>%
                 group_by(Dist, year) %>%
                 summarise_each(funs(sum), -TAZ) %>%
                 gather(key, value,3:5) %>%
                 unite(key2, key, year) %>%
                 spread(key2, value) 
  write.csv(data_all_years, "AirSage_District_hh_pop_emp.csv", row.names = FALSE)   
```


```{r Summary Functions, echo=FALSE}

  # Get SE marginals by county  
  seDataByCounty <- function(df){
      df[is.na(df)] <- 0
      report <- df %>%
                left_join(tazCounty, by = c("TAZ" = "TAZ_REG")) %>%
                filter (COUNTY == 3) %>%
                summarise_each(funs(sum)) 
      return(report)
  }

    # Get SE marginals by county and study area  
  seDataForStudy <- function(df){
      df[is.na(df)] <- 0
      report <- df %>%
                left_join(tazCounty, by = c("TAZ" = "TAZ_REG")) %>%
                left_join(taz_dist_all, by = "TAZ") %>%
                filter (COUNTY == 3, Dist %in% Study_districts) %>%
                summarise_each(funs(sum))
      return(report)
  }  

```


## 3. Landuse Summaries
TODOs: Replace the summaries to show trends by each county instead of just Miami-Dade.

2010 Miami-Dade County population is reported at 2.4 million, with 867,000 households and over 1.1 million employees as per Census 2010.  2040 projected growth is estimated at 25 and 30 percent over 2010 values for population and employment respectively.  Figure 6 shows the socio-demographic growth for Miami-Dade County across different population groups including transit dependent for the three scenario years: 2010, 2015 and 2040.  Most All of the demographic variables show a positive increase. 


> The Federal Transit Administration defines transit dependent persons as those 
1) without private transportation (zero-car households), 
2) elderly (over age 65), 
3) youths (under age 18), and 
4) persons below poverty or median income levels defined by the U.S. Census Bureau.  

Table shows Miami –Dade County and Flagler Corridor population by age cohorts and households by zero auto and income categories for the three scenario years: 2010, 2015 and 2040.  Based on the Census data for 2010, 2015, and 2040, analysis of each of these sectors of the population was analyzed and summarized in the following sections.

```{r Model Summary by County, echo=FALSE}

  # report County trends  
  report_2010 <- seDataByCounty(data_2010) %>% mutate(year = 2010)
  report_2015 <- seDataByCounty(data_2015) %>% mutate(year = 2015)
  report_2040 <- seDataByCounty(data_2040) %>% mutate(year = 2040)
  report <- rbind(report_2010, report_2015, report_2040)
  
  # Write output for general use
  if (write.csv.outputs) {
      write.csv(report, "seData_by_year_County.csv")
  }
  
  # print summary report
  report_print <- report %>% 
                  select(-TAZ, -COUNTY) %>%
                  gather( var, val, -year) %>% 
                  spread(year, val)
  kable(report_print)
  
  report <- report %>% 
            gather(key = Variable, value = number,-year,-TAZ, -COUNTY)
  
```

Table below shows the household, demographics summary for the Corridor

	
**Zero car households**: This is the sector of the population that has no or limited access to personal vehicles and therefore, are most likely to use transit as a mode of transportation.  In 2015, the share of zero car households is 14 percent in the County and 22 percent in the Corridor.  Between 2010 and 2015 the zero car households grew by 5,000 and is projected to double by 2040.  The growth in zero car households is slightly significantly more by 5% in the Corridor, which is estimated to grow to 30 percent by 2040 compared to County wide growth at 18 percent. This implies there will be more potential transit users in the future.   

**Senior citizens**: Senior citizens are individuals between over the ages 65 to 79.  This population is reported in two age cohorts: 65 to 79 and 80Plus. This sector of the population is also considered as one who uses transit as a mode of transportation .  20150 data shows that 12x percent of the population in the Flagler Corridor are included in this category.  The gGrowth in elderly population is estimated to be slightly higher in the Ccorridor than in the County.  The estimated numbers increase by  by 15 percent in the County compared to 25% in the Corridor by 2040.

**Low income households**: Households with an annual income less than $25,000: In 2015, there were about 55,000 low-income households which is about 37 percent in the Corridor where the County consists about 30 percent low-income households.  The Flagler  Corridor is estimated to see retain a slightly higher growth share of low income households at 38 percent than the County at 30 percent by 2040 .


```{r Model Summary by Study Area, echo=FALSE}
  # report Study area trends   
  study_2010 <- seDataForStudy(data_2010) %>% mutate(year = 2010)
  study_2015 <- seDataForStudy(data_2015) %>% mutate(year = 2015)
  study_2040 <- seDataForStudy(data_2040) %>% mutate(year = 2040)
  study_report <- rbind(study_2010, study_2015, study_2040) 
  
  # Write output for general use
  if (write.csv.outputs) {
      write.csv(study_report, "seData_by_year_studyarea.csv")
  }
  
  # print summary report
  study_report_print <- study_report %>% 
                  select(-TAZ, -Dist, -COUNTY) %>%
                  gather( var, val, -year) %>% 
                  spread(year, val)
  kable(study_report_print)
  
  study_report <- study_report  %>% 
            gather(key = Variable, value = number,-year,-TAZ, -Dist)
  

```


Plot of demographic trends


```{r Plots, echo=FALSE}

  # Plot county and study trends  
t <- ggplot(report,aes(x = year,y = number,color=Variable)) +
   geom_line() +
   guides(color = "legend") +
   facet_wrap(~Variable,scales =  "free" ,ncol=3) +
scale_x_continuous(breaks=c(2010,2015,2040))

# Convert to pct to plot trend lines
   report_2010_pct <- (100 * (1 - (report_2010/ report_2010))) %>% mutate(year = 2010, geo = "County") 
   report_2015_pct <- (100 * (1 - (report_2010/ report_2015))) %>% mutate(year = 2015, geo = "County")
   report_2040_pct <- (100 * (1 - (report_2010/ report_2040))) %>% mutate(year = 2040, geo = "County") 
   
   study_2010_pct <- (100 * (1 - (study_2010/ study_2010))) %>% mutate(year = 2010, geo = "Flagler") %>% select(-Dist) 
   study_2015_pct <- (100 * (1 - (study_2010/ study_2015))) %>% mutate(year = 2015, geo = "Flagler") %>% select(-Dist) 
   study_2040_pct <- (100 * (1 - (study_2010/ study_2040))) %>% mutate(year = 2040, geo = "Flagler") %>% select(-Dist) 
   
report_pct <- rbind(report_2010_pct, report_2015_pct, report_2040_pct, 
                       study_2010_pct, study_2015_pct, study_2040_pct) %>% 
                 select(year, Geography = geo, Households = hh, Population = pop, Employment = emp,  AGE0TO17,AGE65TO79, AGE80PLUS, 
                        INCOME_25K, zero_auto) %>%
                 gather(key = Variable, value = percent, -year, -Geography)

  # Plot study trends 
hpe <- c("Households", "Employment", "Population")
trn_depend <- c("AGE0TO17", "AGE65TO79", "AGE80PLUS", "INCOME_25K", "zero_auto")

report_pct_hpe <- report_pct %>% filter(Variable %in% hpe, year != 2015 )
hpe_trends <- ggplot(report_pct_hpe,aes(x = year,y = percent,color=Geography)) +
   geom_line() +
   guides(color = "legend") +
   facet_wrap(~Variable,scales = "free",ncol=3) +
   scale_x_continuous(breaks=c(2010,2040))

hpe_trends

report_pct_trn <- report_pct %>% filter(Variable %in% trn_depend)
transit_dependent <- ggplot(report_pct_trn,aes(x = year,y = percent,color=Geography)) +
   geom_line() +
   guides(color = "legend") +
   facet_wrap(~Variable,scales = "free",ncol=2) +
   scale_x_continuous(breaks=c(2010,2015,2040))

  if (write.csv.outputs) {
      write.csv(report,"se_data_growth.csv", row.names = FALSE)
  }

transit_dependent
  
```
